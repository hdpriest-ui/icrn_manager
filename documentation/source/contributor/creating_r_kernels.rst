Creating R Kernels
==================

This guide walks through the process of creating a new R kernel for the ICRN catalog.

Overview
--------

An R kernel is a packaged environment containing a specific set of R packages. Kernels allow users to quickly switch between different package configurations without manual installation.

Planning Your Kernel
--------------------

Before creating a kernel, consider:

1. **Purpose**: What use case does this kernel serve? (e.g., bioinformatics, geospatial analysis, machine learning)
2. **Core packages**: What are the essential packages for this use case?
3. **Dependencies**: What additional packages are required by the core packages?
4. **R version**: What R version should this kernel target?
5. **Naming**: Choose a descriptive name (e.g., ``bioconductor``, ``tidyverse``, ``geospatial``)

Directory Structure
-------------------

Each kernel must follow this directory structure:

.. code-block:: text

   kernels/
   └── R/
       └── <kernel_name>/
           └── <version>/
               ├── library/           # R packages
               │   ├── package1/
               │   ├── package2/
               │   └── ...
               └── package_manifest.json  # Generated by indexer

Example:

.. code-block:: text

   kernels/
   └── R/
       └── bioconductor/
           └── 3.20/
               ├── library/
               │   ├── Biobase/
               │   ├── BiocGenerics/
               │   └── ...
               └── package_manifest.json

Installing Packages
-------------------

Create a fresh R library directory and install packages:

.. code-block:: r

   # Set the library path for your kernel
   kernel_lib <- "/path/to/kernels/R/mykernel/1.0/library"
   dir.create(kernel_lib, recursive = TRUE)

   # Install packages to the kernel library
   install.packages(
     c("package1", "package2", "package3"),
     lib = kernel_lib,
     dependencies = TRUE
   )

   # For Bioconductor packages
   if (!requireNamespace("BiocManager", quietly = TRUE))
     install.packages("BiocManager", lib = kernel_lib)
   
   BiocManager::install(
     c("BiocPackage1", "BiocPackage2"),
     lib = kernel_lib
   )

Package Manifest
----------------

The ``package_manifest.json`` file is automatically generated by the kernel indexer. It contains:

.. code-block:: json

   {
     "kernel_name": "bioconductor",
     "version": "3.20",
     "language": "R",
     "language_version": "4.4.0",
     "indexed_at": "2024-12-16T10:30:00Z",
     "packages": [
       {
         "name": "Biobase",
         "version": "2.60.0",
         "source": "Bioconductor"
       },
       {
         "name": "ggplot2",
         "version": "3.4.4",
         "source": "CRAN"
       }
     ]
   }

To generate the manifest, run the kernel indexer:

.. code-block:: bash

   ./kernel_indexer index --kernel-root /path/to/kernels --language R

Testing Your Kernel
-------------------

Before submitting, verify your kernel works correctly:

1. **Test activation**:

   .. code-block:: bash

      icrn_manager kernels use R mykernel 1.0

2. **Verify library paths** (after restarting R):

   .. code-block:: r

      .libPaths()
      # Should include your kernel's library path

3. **Test core packages**:

   .. code-block:: r

      library(package1)
      library(package2)
      # Verify packages load without errors

4. **Run package tests** (optional but recommended):

   .. code-block:: r

      # Test key functionality of core packages
      example(function_name)

Submission Process
------------------

1. Create the kernel directory structure in the central repository
2. Install all required packages
3. Run the kernel indexer to generate the manifest
4. Test the kernel thoroughly
5. Update the central catalog (``icrn_kernel_catalog.json``)
6. Notify administrators for review

Versioning Guidelines
---------------------

- Use semantic versioning where possible (e.g., ``1.0``, ``1.1``, ``2.0``)
- For kernels based on external projects, match their version (e.g., ``bioconductor-3.20``)
- Create new versions rather than modifying existing ones
- Document breaking changes between versions

